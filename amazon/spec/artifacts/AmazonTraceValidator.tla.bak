---- MODULE AmazonTraceValidator ----
EXTENDS Naturals, Sequences

(*
  Trace validation for an "Amazon outage" toy model.
  We embed two traces and select one via CONSTANT UseBad.
*)

CONSTANT UseBad

TraceGood ==
<<
  [t |-> 0, type |-> "Launch",     id |-> "i1"],
  [t |-> 1, type |-> "Healthy",    id |-> "i1"],
  [t |-> 2, type |-> "Register",   id |-> "i1"],
  [t |-> 3, type |-> "Unhealthy",  id |-> "i1"],
  [t |-> 4, type |-> "Deregister", id |-> "i1"],
  [t |-> 5, type |-> "Terminate",  id |-> "i1"]
>>

TraceBad ==
<<
  [t |-> 0, type |-> "Launch",     id |-> "i1"],
  [t |-> 1, type |-> "Healthy",    id |-> "i1"],
  [t |-> 2, type |-> "Register",   id |-> "i1"],
  [t |-> 3, type |-> "Unhealthy",  id |-> "i1"],
  [t |-> 4, type |-> "Register",   id |-> "i1"]  \* bug: unhealthy but (re)registered
>>

Trace == IF UseBad THEN TraceBad ELSE TraceGood

VARIABLES i, inst, healthy, pool

Init ==
  /\ i = 1
  /\ inst = {}
  /\ healthy = {}
  /\ pool = {}

Step(e) ==
  CASE e.type = "Launch" ->
        /\ inst' = inst \cup {e.id}
        /\ UNCHANGED <<healthy, pool>>

  [] e.type = "Healthy" ->
        /\ e.id \in inst
        /\ healthy' = healthy \cup {e.id}
        /\ UNCHANGED <<inst, pool>>

  [] e.type = "Unhealthy" ->
        /\ e.id \in inst
        /\ healthy' = healthy \ {e.id}
        /\ pool' = pool \ {e.id}
        /\ inst' = inst

  [] e.type = "Register" ->
        /\ e.id \in inst
        /\ pool' = pool \cup {e.id}
        /\ UNCHANGED <<inst, healthy>>

  [] e.type = "Deregister" ->
        /\ pool' = pool \ {e.id}
        /\ UNCHANGED <<inst, healthy>>

  [] e.type = "Terminate" ->
        /\ e.id \in inst
        /\ inst' = inst \ {e.id}
        /\ healthy' = healthy \ {e.id}
        /\ pool' = pool \ {e.id}

  [] OTHER ->
        /\ UNCHANGED <<inst, healthy, pool>>

Next ==
  IF i <= Len(Trace) THEN
    /\ LET e == Trace[i] IN Step(e)
    /\ i' = i + 1
  ELSE
    /\ UNCHANGED <<i, inst, healthy, pool>>


Inv ==
  /\ pool \subseteq inst
  /\ pool \subseteq healthy

Spec == Init /\ [][Next]_<<i,inst,healthy,pool>>

====
